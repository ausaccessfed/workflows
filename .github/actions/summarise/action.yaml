name: 'Summarise'
description: ''
inputs:
  OUTPUT_FILE:
    description: 'file containing output to be posted'
  TITLE:
    description: 'Summary Title'
  SUCCESS:
    description: 'If the task was successful'
runs:
  using: 'composite'
  steps:
    # TODO: do we want to also add logic to post as a pr comment ?
    # TODO: do we want to also add logic to post as a webhook to slack?
    - id: split_file
      shell: bash
      run: |
        FILE_SIZE=$(stat -c%s "${{ inputs.OUTPUT_FILE }}")
        CHUNK_SIZE=$((900 * 1024)) # 700KB in bytes

        if [ $FILE_SIZE -gt $CHUNK_SIZE ]; then
          split -b $CHUNK_SIZE "${{ inputs.OUTPUT_FILE }}" chunk_
          echo "File split into chunks."
        else
          cp "${{ inputs.OUTPUT_FILE }}" chunk_aa
          echo "File is small enough, no need to split."
        fi
    - id: summary_tab_1
      shell: bash
      run: |
        tmp="tmp_aa.txt"
        if [ -s "chunk_aa" ]; then
          echo '<details>' > $tmp
          echo "<summary>${{ inputs.TITLE }} (part 1)</summary>" >> $tmp
          echo '```' >> $tmp
          cat chunk_aa >> $tmp
          echo '```' >> $tmp
          echo '</details>' >> $tmp
          cat $tmp >> $GITHUB_STEP_SUMMARY
        else
          echo "Output file is empty, skipping summary."
        fi
    - id: summary_tab_2
      shell: bash
      run: |
        tmp="tmp_ab.txt"
        if [ -s "chunk_ab" ]; then
          echo '<details>' > $tmp
          echo "<summary>${{ inputs.TITLE }} (part 1)</summary>" >> $tmp
          echo '```' >> $tmp
          cat chunk_aa >> $tmp
          echo '```' >> $tmp
          echo '</details>' >> $tmp
          cat $tmp >> $GITHUB_STEP_SUMMARY
        fi
    - id: summary_tab_3
      shell: bash
      run: |
        tmp="tmp_ac.txt"
        if [ -s "chunk_ac" ]; then
          echo '<details>' > $tmp
          echo "<summary>${{ inputs.TITLE }} (part 1)</summary>" >> $tmp
          echo '```' >> $tmp
          cat chunk_aa >> $tmp
          echo '```' >> $tmp
          echo '</details>' >> $tmp
          cat $tmp >> $GITHUB_STEP_SUMMARY
        fi
    - id: summary_tab_4
      shell: bash
      run: |
        if [ -s "chunk_ad" ]; then
          echo 'We shouldn\'t be getting outputs this big!'
          exit 1
        fi
    - id: throw_error
      shell: bash
      if: inputs.SUCCESS == 'failure' || inputs.SUCCESS == 'false'
      run: exit 1
