name: "Distribute Workflows"
on:
  workflow_dispatch:
  # TODO: disable push
  push:
jobs:
  distribution:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0

      - uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6.4.1
        with:
          github-token: ${{secrets.ALL_REPO_SCOPED_TOKEN}}
          script: |
            const fs = require('fs')
            let {
              repo: {
                  owner
              }
            } = context
            const committer = context.pusher ?? {
              name: "todo",
              email:  "todo"
            }
            //const repos = ${{ vars.RENOVATE_REPOSITORIES }}
            const repos = ['ausaccessfed/reporting-service']
            const globber = await glob.create('**/**/distributions/*.yml', {followSymbolicLinks: false})
            const files = await globber.glob()

            for(let i = 0;i < files.length;i++) {
              const fileName = files[i]
              const fileNameCleaned = fileName.split("/").pop()
              const content = fs.readFileSync(fileName,{ encoding: 'utf8', flag: 'r' })
              const branch = `feature/${fileNameCleaned}`
              for(let x = 0;x < repos.length;x++) {
                const repo = repos[x].split("/").pop()
                const {
                  data: {
                    default_branch: base
                  }
                } = await github.rest.repos.get({
                  owner,
                  repo,
                });
                const message = `Updating ${fileNameCleaned}`
                await github.rest.repos.createOrUpdateFileContents({
                  owner,
                  repo,
                  branch,
                  path: `.github/workflows/${fileNameCleaned}`,
                  message,
                  Base64.encode(content),
                  committer 
                })
                await github.rest.pulls.create({
                  owner,
                  repo,
                  head: branch,
                  base,
                  title: message,
                  body: message
                })
              }
            }
